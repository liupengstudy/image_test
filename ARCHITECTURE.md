# 系统架构文档

本文档详细描述Dream Machine项目的系统架构设计。

## 系统概述

Dream Machine是一个AI图像生成平台，允许用户通过文本描述生成高质量图像。系统采用前后端分离架构，前端使用React构建用户界面，后端使用Node.js和Express提供API服务。

## 架构设计原则

1. **关注点分离**：将系统分为不同的层次，每个层次负责特定的功能
2. **单一职责**：每个组件只负责一个功能，降低耦合度
3. **依赖注入**：通过依赖注入降低组件间的耦合
4. **错误处理**：统一的错误处理机制
5. **可测试性**：设计便于测试的架构
6. **可扩展性**：设计易于扩展的架构，支持新功能添加
7. **用户体验优先**：设计决策以提升用户体验为主要考虑因素

## 系统架构

### 前端架构

前端采用组件化架构，由多个功能组件组成，主要包括：

#### 核心组件

1. **CreatorPage**：
   - 创意生成页面的主容器
   - 管理用户输入、图像生成和展示的状态
   - 包含子组件：
     - Conversation（对话组件）
     - BrainstormPanel（头脑风暴面板）
     - ProjectsPage（项目管理页面）
     - AspectRatioSelector（宽高比选择器）

2. **Conversation**：
   - 展示图像生成结果和对话历史
   - 包含不同消息类型的展示组件
   - 支持图像引用和"显示更多"功能
   - 负责处理图像布局和显示

3. **BrainstormPanel**：
   - 提供创意提示词的侧边面板
   - 按分类组织提示词
   - 支持点击选择提示词填充到输入框

4. **ProjectsPage**：
   - 展示和管理用户项目
   - 创建新项目和切换项目功能
   - 项目卡片展示界面

5. **AspectRatioSelector**：
   - 使用React Portal实现的宽高比选择器
   - 提供多种预设宽高比选项
   - 浮动显示在用户界面上

6. **浮动UI元素**：
   - 浮动标题栏：显示当前项目标题和分享按钮
   - 浮动输入框：用户输入区域和操作按钮
   - 浮动图像预览：上传和引用的图像预览
   - 浮动错误提示：显示操作错误信息

#### 状态管理

前端使用React Hooks进行状态管理：

1. **全局状态**：
   - 当前视图状态（创作模式/项目列表）
   - 当前项目信息
   - 生成中状态
   - 错误信息

2. **创作状态**：
   - 用户输入的提示词
   - 消息历史
   - 上传的图像
   - 引用的图像
   - 宽高比设置
   - 生成状态

3. **UI状态**：
   - 头脑风暴面板显示状态
   - 宽高比选择器显示状态
   - 滚动位置
   - 输入框焦点

#### 数据流动

1. **用户输入 → 图像生成**：
   - 用户在输入框中输入文本或上传图像
   - 选择合适的宽高比设置
   - 点击提交按钮触发API请求
   - 显示生成中状态
   - 接收并展示生成结果

2. **头脑风暴流程**：
   - 用户点击头脑风暴按钮
   - 显示头脑风暴面板
   - 用户选择提示词
   - 选中的提示词填充到输入框
   - 面板自动关闭

3. **宽高比选择流程**：
   - 用户点击宽高比选择器按钮
   - 显示宽高比选择面板
   - 用户选择所需宽高比
   - 更新宽高比状态
   - 关闭选择面板

4. **"显示更多"流程**：
   - 用户点击"显示更多"按钮
   - 使用相同的提示词和当前宽高比再次生成图像
   - 新生成的图像添加到现有图像集合中

5. **项目管理流程**：
   - 用户切换到项目列表视图
   - 浏览现有项目
   - 选择项目或创建新项目
   - 切换回创作视图

6. **图像引用流程**：
   - 用户点击已生成图像的引用按钮
   - 图像添加到引用区域
   - 用户输入新提示词
   - 生成新图像时考虑引用图像

### 后端架构

后端采用分层架构，主要包括：

#### 核心层次

1. **路由层**：
   - 定义API端点
   - 处理HTTP请求和响应
   - 路由请求到相应的控制器

2. **控制器层**：
   - 处理路由传来的请求
   - 调用相应的服务
   - 格式化响应数据

3. **服务层**：
   - 实现核心业务逻辑
   - 调用外部API
   - 处理数据转换

4. **数据访问层**：
   - 与数据库交互
   - 提供数据CRUD操作

5. **中间件层**：
   - 处理认证和授权
   - 请求日志记录
   - 错误处理

#### 关键服务

1. **图像生成服务**：
   - 提示词优化：调用阿里云QWQ模型优化用户输入
   - 图像生成：调用阿里云通义万相API生成图像
   - 宽高比处理：根据用户选择的宽高比设置生成图像尺寸
   - 图像处理：处理和优化生成的图像

2. **用户服务**：
   - 用户注册和登录
   - 用户配置管理

3. **项目服务**：
   - 项目创建和管理
   - 项目数据存储和检索

#### 数据流动

1. **图像生成流程**：
   - 用户发送生成请求（包含提示词、宽高比和可选参考图像）
   - 控制器接收请求并验证
   - 调用QWQ服务优化提示词
   - 根据宽高比参数确定图像尺寸
   - 调用图像生成服务创建图像
   - 返回生成的图像URL
   - 记录生成历史

2. **错误处理流程**：
   - 捕获服务层异常
   - 转换为统一错误格式
   - 记录详细错误日志
   - 返回适当的HTTP状态码和用户友好的错误信息
   - 前端显示错误提示

## 数据模型

### 主要实体

1. **用户**：
   - ID
   - 用户名
   - 邮箱
   - 密码哈希
   - 创建时间

2. **项目**：
   - ID
   - 名称
   - 描述
   - 创建时间
   - 用户ID
   - 背景色

3. **提示词历史**：
   - ID
   - 用户ID
   - 项目ID
   - 原始提示词
   - 优化后提示词
   - 宽高比设置
   - 创建时间

4. **图像**：
   - ID
   - 用户ID
   - 项目ID
   - 提示词ID
   - 图像URL
   - 宽高比
   - 尺寸信息
   - 创建时间
   - 喜爱状态

## 错误处理策略

1. **前端错误处理**：
   - 请求错误：网络问题、超时、服务器错误等
   - 用户输入错误：无效输入、格式错误等
   - UI交互错误：无效操作、状态冲突等
   - 显示用户友好的错误消息
   - 提供重试和恢复机制

2. **后端错误处理**：
   - API参数验证错误
   - 业务逻辑错误
   - 外部服务错误（阿里云API）
   - 数据库错误
   - 系统级错误（磁盘空间不足等）
   - 提供详细错误日志和适当的客户端响应

3. **错误恢复机制**：
   - 前端自动重试机制
   - 后端请求重试和回退策略
   - 部分成功时的结果保存
   - 状态恢复和会话维护

## 安全考虑

1. **认证与授权**：
   - JWT令牌认证
   - 基于角色的访问控制

2. **数据安全**：
   - 输入验证
   - 防止SQL注入
   - XSS防护

3. **API安全**：
   - 速率限制
   - API密钥管理
   - HTTPS传输

## 可扩展性考虑

1. **水平扩展**：
   - 无状态API设计
   - 负载均衡支持

2. **垂直扩展**：
   - 模块化设计
   - 可独立升级的组件

3. **功能扩展**：
   - 插件式架构
   - 清晰的接口定义
   - 支持添加新的图像生成模型和服务

## 性能优化

1. **前端优化**：
   - 懒加载图像
   - 代码分割
   - 资源压缩
   - 缓存策略

2. **后端优化**：
   - 请求合并
   - 数据缓存
   - 并行处理
   - 异步操作

3. **API优化**：
   - 减少请求频率
   - 优化请求大小
   - 实现长轮询或WebSocket

## 测试策略

1. **单元测试**：测试各个组件的独立功能
2. **集成测试**：测试组件间的交互
3. **端到端测试**：测试整个系统流程
4. **性能测试**：测试系统在负载下的表现
5. **用户体验测试**：测试系统的易用性和用户满意度

## 部署架构

计划采用以下部署架构：

1. **前端**：部署到静态网站托管服务
2. **后端**：部署到容器化环境
3. **数据库**：使用托管的MongoDB服务
4. **日志**：集中式日志管理
5. **监控**：应用性能监控
6. **CDN**：用于静态资源和图像分发 