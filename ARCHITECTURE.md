# 系统架构文档

本文档详细描述Dream Machine项目的系统架构设计。

## 系统概述

Dream Machine是一个AI图像生成平台，允许用户通过文本描述生成高质量图像。系统采用前后端分离架构，前端使用React构建用户界面，后端使用Node.js和Express提供API服务。

## 架构设计原则

1. **关注点分离**：将系统分为不同的层次，每个层次负责特定的功能
2. **单一职责**：每个组件只负责一个功能，降低耦合度
3. **依赖注入**：通过依赖注入降低组件间的耦合
4. **错误处理**：统一的错误处理机制
5. **可测试性**：设计便于测试的架构

## 系统架构

### 前端架构

前端采用React框架，使用TypeScript进行类型检查，使用Tailwind CSS进行样式设计。

#### 前端目录结构

```
client/
├── public/             # 静态资源
└── src/                # 源代码
    ├── components/     # 可复用组件
    ├── pages/          # 页面组件
    ├── services/       # API服务
    ├── hooks/          # 自定义钩子
    ├── utils/          # 工具函数
    ├── types/          # 类型定义
    ├── App.tsx         # 主应用组件
    └── main.tsx        # 入口文件
```

#### 前端组件设计

1. **页面组件**：负责整体页面布局和状态管理
   - HomePage：首页，展示产品特性
   - CreatorPage：创作页面，用于生成和查看图像

2. **UI组件**：负责展示和用户交互
   - ImageGallery：图像展示组件
   - PromptInput：提示词输入组件
   - LoadingIndicator：加载指示器

3. **服务**：负责与后端API通信
   - api.ts：封装API请求

### 后端架构

后端采用Node.js和Express框架，使用TypeScript进行类型检查，使用MongoDB存储数据。

#### 后端目录结构

```
server/
├── src/                # 源代码
│   ├── config.ts       # 配置
│   ├── controllers/    # 控制器
│   ├── middlewares/    # 中间件
│   ├── models/         # 数据模型
│   ├── routes/         # 路由
│   ├── services/       # 服务
│   ├── types/          # 类型定义
│   ├── utils/          # 工具函数
│   └── index.ts        # 入口文件
├── tests/              # 测试文件
│   ├── unit/           # 单元测试
│   ├── integration/    # 集成测试
│   └── setup.ts        # 测试配置
└── .env                # 环境变量
```

#### 后端层次结构

1. **路由层**：定义API路由和参数验证
   - imageRoutes.ts：图像相关路由

2. **控制器层**：处理HTTP请求和响应
   - imageController.ts：图像相关控制器

3. **服务层**：实现业务逻辑
   - imageGenerationService.ts：图像生成服务

4. **模型层**：定义数据结构和数据库交互
   - Image.ts：图像模型
   - User.ts：用户模型

5. **中间件层**：处理认证、错误等
   - errorHandler.ts：错误处理中间件
   - validator.ts：请求验证中间件

6. **工具层**：提供通用功能
   - logger.ts：日志工具
   - envValidator.ts：环境变量验证工具

7. **类型定义层**：定义TypeScript类型
   - api.ts：API相关类型
   - config.ts：配置相关类型
   - models.ts：模型相关类型

## 数据流

### 图像生成流程

1. 用户在前端输入提示词
2. 前端发送请求到后端API
3. 后端控制器接收请求并验证参数
4. 控制器调用图像生成服务
5. 服务使用阿里云QWQ模型优化提示词
6. 服务使用阿里云通义万相API生成图像
7. 服务返回图像URL给控制器
8. 控制器将图像URL返回给前端
9. 前端展示生成的图像

### 错误处理流程

1. 服务层抛出错误
2. 控制器捕获错误并传递给错误处理中间件
3. 错误处理中间件格式化错误并返回给客户端
4. 前端展示错误信息

## 外部依赖

1. **阿里云通义万相API**：用于生成图像
2. **阿里云QWQ模型**：用于优化提示词
3. **MongoDB**：用于存储数据

## 安全考虑

1. **API密钥保护**：API密钥存储在环境变量中，不直接暴露在代码中
2. **输入验证**：所有用户输入都经过验证
3. **错误处理**：不向客户端暴露敏感错误信息

## 性能考虑

1. **异步处理**：使用异步API调用避免阻塞
2. **缓存**：计划实现图像缓存机制
3. **数据库索引**：为常用查询添加索引

## 可扩展性考虑

1. **模块化设计**：便于添加新功能
2. **API版本控制**：便于API演进
3. **配置驱动**：通过配置控制系统行为

## 测试策略

1. **单元测试**：测试各个组件的独立功能
2. **集成测试**：测试组件间的交互
3. **端到端测试**：测试整个系统流程

## 部署架构

计划采用以下部署架构：

1. **前端**：部署到静态网站托管服务
2. **后端**：部署到容器化环境
3. **数据库**：使用托管的MongoDB服务
4. **日志**：集中式日志管理
5. **监控**：应用性能监控 